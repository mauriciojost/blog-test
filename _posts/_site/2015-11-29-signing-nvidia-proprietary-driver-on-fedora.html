<p>Two weeks ago I have upgraded my machine to Fedora 23. I fought a bit with the
installation of Nvidia proprietary driver. The main reason was that new kernel
modules to load need to be signed with a key accepted by <a href="https://docs.fedoraproject.org/en-US/Fedora/23/html/System_Administrators_Guide/sect-signing-kernel-modules-for-secure-boot.html">Secure Boot</a>.
Below are steps I have followed to achieve this configuration.</p>

<!--more-->

<h1 id="creating-new-x509-key-pair">Creating New X.509 Key Pair</h1>

<p>The <a href="https://www.openssl.org">openssl</a> tool can be used to generate a public
and private X.509 key pair that will be used to sign a kernel module after it
has been built.</p>

<p>First, it is recommended to create a configuration file to pass parameters.
Hereafter is an example named <em>x509-configuration.ini</em>. Values starting by
<code class="highlighter-rouge">YOUR_</code> need to be replaced by your own data:</p>

<div class="language-ini highlighter-rouge"><pre class="highlight"><code><span class="nn">[ req ]</span>
<span class="py">default_bits</span> <span class="p">=</span> <span class="s">4096</span>
<span class="py">distinguished_name</span> <span class="p">=</span> <span class="s">req_distinguished_name</span>
<span class="py">prompt</span> <span class="p">=</span> <span class="s">no</span>
<span class="py">string_mask</span> <span class="p">=</span> <span class="s">utf8only</span>
<span class="py">x509_extensions</span> <span class="p">=</span> <span class="s">myexts</span>

<span class="nn">[ req_distinguished_name ]</span>
<span class="py">O</span> <span class="p">=</span> <span class="s">YOUR_USERNAME</span>
<span class="py">CN</span> <span class="p">=</span> <span class="s">YOUR_USERNAME</span>
<span class="py">emailAddress</span> <span class="p">=</span> <span class="s">YOUR_EMAIL_ADDRESS</span>

<span class="nn">[ myexts ]</span>
<span class="py">basicConstraints</span><span class="p">=</span><span class="s">critical,CA:FALSE</span>
<span class="py">keyUsage</span><span class="p">=</span><span class="s">digitalSignature</span>
<span class="py">subjectKeyIdentifier</span><span class="p">=</span><span class="s">hash</span>
<span class="py">authorityKeyIdentifier</span><span class="p">=</span><span class="s">keyid</span>
</code></pre>
</div>

<p>Then, key pair can be generated as follows:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 -batch -config x509-configuration.ini -outform DER -out public_key.der -keyout private_key.priv
</code></pre>
</div>

<p>Output are two files: <code class="highlighter-rouge">public_key.der</code> and <code class="highlighter-rouge">private_key.priv</code>.</p>

<h1 id="enrolling-public-key">Enrolling Public Key</h1>

<p>At boot, the kernel loads Secure Boot db key database into system keyring. Since
this last is used to check which kernel modules can be loaded, the public key
<code class="highlighter-rouge">public_key.der</code> needs to be enrolled in this database in order to accept new
modules signed with our private key <code class="highlighter-rouge">private_key.priv</code>.</p>

<p>Usually, this operation can be achieved with <em>mokutil</em> Fedora userspace utility:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>mokutil --import mpublic_key.der
</code></pre>
</div>

<p>Unfortunately, this utility was not working for me. I was always getting
<em>Failed to enroll new keys</em>. Hopefully, it is possible to enroll a new key
from the UEFI interface, directly.</p>

<p>First, copy file <code class="highlighter-rouge">public_key.der</code> on an USB key, then restart your machine and
press the appropriate key to access your UEFI interface.</p>

<p>In my case the right key is <em>F2</em>. Once pressed, the UEFI interface of my
<em>SABERTOOTH Z97 MARK 1</em> motherboard is displayed. To configure Secure Boot keys,
I clicked on <em>Advanced Mode</em>, <em>Boot</em>, <em>Secure Boot</em> and <em>Key Management</em>.
From the panel I selected <em>Append default DB keys</em>, answered <em>No</em> to the question
that asked if I wanted to append default DB keys. This way it asked me from
where I wanted to load keys. It allowed me to select my public key from USB key.</p>

<p>Once loaded, you can restart your machine. All new kernel modules signed with
the private key generated previously should be loaded with success by the
kernel.</p>

<h1 id="signing-kernel-module">Signing kernel module</h1>

<p>Move to the folder that contains the nvidia kernel module compiled. If
proprietary driver was installed by <code class="highlighter-rouge">dnf</code> the location should be
<code class="highlighter-rouge">/usr/lib/modules/$(uname -r)/extra/nvidia-340xx/</code>.</p>

<p>At this location, two files should be available: <code class="highlighter-rouge">nvidia.ko</code> and
<code class="highlighter-rouge">nvidia-uvm.ko</code>.</p>

<p>Signing both modules is as simple as follows (assuming package <code class="highlighter-rouge">kernel-devel</code>
is installed):</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>perl /usr/src/kernels/<span class="k">$(</span>uname -r<span class="k">)</span>/scripts/sign-file sha256 ~/private_key.priv  ~/public_key.der  nvidia.ko
perl /usr/src/kernels/<span class="k">$(</span>uname -r<span class="k">)</span>/scripts/sign-file sha256 ~/private_key.priv  ~/public_key.der  nvidia-uvm.ko
</code></pre>
</div>

<p>Then, module can be loaded with <code class="highlighter-rouge">insmod</code> and loaded modules listed with
<code class="highlighter-rouge">listmod</code>.</p>
