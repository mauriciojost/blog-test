<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Laurent Pellegrino">
  <meta name="theme-color" content="#284a5e">
  <title>String concatenation with Java 8</title>
  <meta name="description" content="String concatenation is one of the most well known caveat in Java. Almost all experienced Java developpers have already heard or read explanations about when...">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.pellegrino.link/2015/08/22/string-concatenation-with-java-8.html">
  <link rel="alternate" type="application/rss+xml" title="Laurent Pellegrino" href="http://www.pellegrino.link/feed.xml">
</head>

<body>
	<div id="container">
		<div id="row">
			<header id="sidebar">
  <a href="/"/>
    <img src="/images/giraffe.png" class="avatar" alt="Cartoon giraffe" />
  </a>

  <h1>
    <strong>I am Laurent</strong>,<br /> a Software Engineer</h1>

  <nav class="site-nav vspace">
    <a href="/" class="navlink">Blog</a>
    <span style="font-size: 10px;">&nbsp;&bull;&nbsp;</span>
    <a href="/archives" class="navlink">Archives</a>
    <span style="font-size: 10px;">&nbsp;&bull;&nbsp;</span>
    <a href="/about" class="navlink">About</a>
  </nav>

  <ul class="icons vspace">
    <li><a href="http://linkedin.pellegrino.link" class="icon fa-linkedin" title="Linkedin profile"><span class="label">Linkedin</span></a></li>
    <li><a href="https://github.com/lpellegr" class="icon fa-github" title="Github profile"><span class="label">Github</span></a></li>
    <li><a href="http://stackoverflow.com/users/269447/laurent" class="icon fa-stack-overflow" title="Stackoverflow profile"><span class="label">Stack Overflow</span></a></li>
    <li><a href="http://www.google.com/recaptcha/mailhide/d?k=01aQ9xMzKtmiI_QFsoA7_5cw==&amp;c=tRqec_6YI_OyihG21CXPRw7EZ3YIpLSQjW_ZCODLh0s=" onclick="window.open('http://www.google.com/recaptcha/mailhide/d?k\07501aQ9xMzKtmiI_QFsoA7_5cw\75\75\46c\75tRqec_6YI_OyihG21CXPRw7EZ3YIpLSQjW_ZCODLh0s\075', '', 'toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=500,height=300'); return false;" title="Reveal this e-mail address" class="icon fa-envelope-o"><span class="label">Email</span></a></li>
  </ul>
</header>

			<section id="page-content">
				<div id="content">
					<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <p class="post-meta"><time datetime="2015-08-22T00:00:00+02:00" itemprop="datePublished">Aug 22, 2015</time></p>
    <h1 class="post-title" itemprop="name headline">String concatenation with Java 8</h1>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>String concatenation is one of the most well known caveat in Java. Almost all experienced Java developpers have already heard or read explanations about when to use <em>String</em> vs <em>StringBuilder</em>/<em>StringBuffer</em> for concatenating Strings.</p>

<p>These last months I gave some interviews for a Java position in the company where I work. One of the exercices that candidate sometimes have to work on requires to concatenate Strings in a for loop. Obviously, as a <del>pervert</del> programmer, I like to ask people what they think about the performance of the code they write and how it could be improved. The answers were really surprising, especially about String concatenation. Although some explanations were not really convincing, they let me doubt whether using <em>StringBuilder</em>/<em>StringBuffer</em> is still required with a recent Java virtual machine.  For this reason, I decided to do some investigations.</p>

<!--more-->

<h1 id="understanding-the-issue">Understanding the issue</h1>

<p>In Java String objects are immutable. It means that any operation on a String object will not alter the content of the object but create a new one with the transformed value.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">1</span><span class="n">e6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="s">"some more data"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>
<p>For instance, the piece of code introduced above is a simple loop that iterates 1M times and concatenates the String &quot;some more data&quot; to the <em>result</em> variable at each iteration. However, using the <em>+</em> operator (which is strictly equivalent to <em>result = result + &quot;some more data&quot;</em> in our example) or even <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/String.html#concat-java.lang.String-">String#concat(String)</a> does not mean that internally data are sticked at the end of the <em>result</em> variable in one step. It is not possible since String objects are immutable.</p>

<p>Under the hood, many operations occur. First, a new array of characters is allocated with a size that fits the existing value contained by the <em>result</em> variable but also the payload that is appended. Then, their value is copied to the new array instance and a new String object is created from the array. Finally, the new String instance replaces the one already assigned to the <em>result</em> variable and this last is marked for <a href="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html">garbage collection</a> since it is not longer referenced by a variable.  </p>

<p>This sequence of actions means that as the <em>result</em> variable grows, the amount of data to copy each time grows and the time to complete the operation too. Simple mathematics can be applied to estimate the complexity of the previous piece of code in terms of copy required.</p>

<p>At the first iteration, $14$ characters are copied to an array of characters of size $0 + 14$. The second iteration copies $28$ characters to an array of characters of size $14 + 14$. Then, at the third iteration, an array of size $28 + 14$ is allocated and $36$ characters copied into, and so on and so forth.</p>

<p>In summary, the number of copy required for <em>n</em> iterations is equals to:</p>

<p>$$\sum_{i=0}^{n-1} 14 \times i = 7n(n-1) = 7n^2-7n$$</p>

<p>If you already took a complexity class, you probably remember that $7n^2-7n$ means that your algorithm complexity is in $O(n^2)$, namely quadratic.</p>

<h1 id="stringbuilder-stringbuffer-to-the-rescue">StringBuilder/StringBuffer to the rescue</h1>

<p>As explained previously, the complexity of a simple Java loop concatenating Strings using the &quot;+&quot; operator is quadratic. That&#39;s not good, especially for a simple operation such as concatenation. Let&#39;s say that copying 10 characters takes 10ms, then it means that copying 100 characters will take 1s. In other words, a problem 10 times larger takes 100 times more work.</p>

<p>Hopefully, a solution to this issue exists. It consists in using the <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/StringBuilder.html">StringBuilder</a> or <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/StringBuffer.html">StringBuffer</a> class. The main difference between both is that the last is <a href="https://en.wikipedia.org/wiki/Thread_safety">thread-safe</a> whereas the first is not. Below is an example solving the issue explained previously:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">1</span><span class="n">e6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"some more data"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>You can see an instance of <em>StringBuilder</em>/<em>StringBuffer</em> like a mutable String object. The <em>append</em> call alters the state of the object, thus avoiding several copies.</p>

<p>Internally, <em>StringBuilder</em> makes use of a resizable array and an index that indicates the position of the last cell used in the array. When a new String is appended, its characters are copied to the end of the array and the index shifted to the right. If the internal array is full, its size is doubled (to be exact, if the array size is $x$, then the new size will be <a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/e52f33586140/src/share/classes/java/lang/AbstractStringBuilder.java#l128">$2x+2$</a>).</p>

<p>So, why is this manner to proceed faster than the one used with the <em>+</em> operator? The reason lies in the fact that array expansion and the associated copy of characters is performed occasionally, when the array is full. Asymptotically speaking, by using $2x+2$ as an expansion factor, the resize operation does not occur so often and StringBuilder#append(String) thus <a href="http://www.quora.com/What-is-the-complexity-of-Java-StringBuffer-append">takes O(1) amortized time</a>. Consequently, the whole loop has a complexity in $O(n)$.</p>

<h1 id="looking-at-the-bytecode">Looking at the Bytecode</h1>

<p>What I explained is maybe boring but an interesting question is <em>does the previous explanations still hold with Java 8</em>? I mean is it still required to use <em>StringBuilder</em>/<em>StringBuffer</em> or some magic tricks are applied with the <em>+</em> operator? since going in deep in the <a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/">source code of JDK 8</a> would require a few weeks, an alternative to answer the question is to look at the bytecode generated by the compiler.</p>

<p>Let&#39;s start with a simple example:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StaticStringConcatenation</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">"some more data"</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>An human readable representation of the bytecode that is generated by <em>javac</em> can be obtained for the Java class above. It requires first to generate the class file associated to the source code, then to disassemble this last file using the <em>javap</em> command. Since the previous code, along with all others resources introduced in this post are available on Github in a <a href="https://github.com/lpellegr/experiments/tree/master/java/string-concatenation">dedicated Gradle project</a>, both steps can be reproduced as follows once the project has been cloned:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="err">$</span> <span class="o">./</span><span class="n">gradlew</span> <span class="n">build</span> <span class="o">&amp;&gt;-</span>
<span class="err">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">classes</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">StaticStringConcatenation</span><span class="o">.</span><span class="na">class</span>
<span class="n">Compiled</span> <span class="n">from</span> <span class="s">"StaticStringConcatenation.java"</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StaticStringConcatenation</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">StaticStringConcatenation</span><span class="o">();</span>
    <span class="nl">Code:</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">aload_0</span>          <span class="c1">// Push 'this' on to the stack</span>
       <span class="mi">1</span><span class="o">:</span> <span class="n">invokespecial</span> <span class="err">#</span><span class="mi">1</span> <span class="c1">// Invoke Object class constructor</span>
                           <span class="c1">// pop 'this' ref from the stack</span>
       <span class="mi">4</span><span class="o">:</span> <span class="k">return</span>           <span class="c1">// Return from constructor</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]);</span>
    <span class="nl">Code:</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">2</span> <span class="c1">// Load constant #2 on to the stack</span>
       <span class="mi">2</span><span class="o">:</span> <span class="n">astore_1</span>         <span class="c1">// Create local var from stack (pop #2)</span>
       <span class="mi">3</span><span class="o">:</span> <span class="k">new</span>           <span class="err">#</span><span class="mi">3</span> <span class="c1">// Push new StringBuilder ref on stack</span>
       <span class="mi">6</span><span class="o">:</span> <span class="n">dup</span>              <span class="c1">// Duplicate value on top of the stack</span>
       <span class="mi">7</span><span class="o">:</span> <span class="n">invokespecial</span> <span class="err">#</span><span class="mi">4</span> <span class="c1">// Invoke StringBuilder constructor</span>
                           <span class="c1">// pop object reference</span>
      <span class="mi">10</span><span class="o">:</span> <span class="n">aload_1</span>          <span class="c1">// Push local variable containing #2</span>
      <span class="mi">11</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">5</span> <span class="c1">// Invoke method StringBuilder.append()</span>
                           <span class="c1">// pop obj reference + parameter</span>
                           <span class="c1">// push result (StringBuilder ref)</span>
      <span class="mi">14</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="mi">6</span> <span class="c1">// Push "some more data" on the stack</span>
      <span class="mi">16</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">5</span> <span class="c1">// Invoke StringBuilder.append</span>
                           <span class="c1">// pop twice, push result</span>
      <span class="mi">19</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">7</span> <span class="c1">// Invoke StringBuilder.toString:();</span>
      <span class="mi">22</span><span class="o">:</span> <span class="n">astore_1</span>         <span class="c1">// Create local var from stack (pop #6)</span>
      <span class="mi">23</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">8</span> <span class="c1">// Push value System.out:PrintStream</span>
      <span class="mi">26</span><span class="o">:</span> <span class="n">aload_1</span>          <span class="c1">// Push local variable containing #6</span>
      <span class="mi">27</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">9</span> <span class="c1">// Invoke method PrintStream.println()</span>
                           <span class="c1">// pop twice (object ref + parameter)</span>
      <span class="mi">30</span><span class="o">:</span> <span class="k">return</span>           <span class="c1">// Return void from method</span>
<span class="o">}</span>
</code></pre></div>
<p>In the output above, comments have been manually edited to get a text that fits in the page but also to clarify the bytecode <a href="https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings">instructions</a>. In consequence, it&#39;s normal if you get more obscure comment messages when you try to execute the previous commands.</p>

<p>Before continuing, some explanations about the JVM internals are required. The Java Virtual Machine (JVM) is an abstract machine that provides a runtime environment in which Java bytecode can be executed. To this aim, the JVM is <a href="http://blog.jamesdbloom.com/JVMInternals.html">made of several components</a> including among others:</p>

<ul>
<li>an <em>Operand Stack</em> (named <em>stack</em> in the following) that aims to execute bytecode instructions similarly to registers with a CPU;</li>
<li>a <em>Run Time Constant Pool</em> (referred to as <em>constant pool</em> below) to maintain a per-type constant pool;</li>
<li>a <em>Heap</em> that is used to allocate class instances and arrays at runtime.</li>
</ul>

<p>The output produced by <em>javap</em> displays the bytecode instructions using JVM opcodes (<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.4-mnemonic">mnemonics</a> to be exact). For instance, <em>aload_0</em> is the first opcode executed when the constructor of the class <em>StaticStringConcatenation</em> is invoked. Its purpose is to push &#39;this&#39; (the reference to the local object created in the heap) on to the stack. Then, <em><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.invokespecial">invokespecial</a></em>  invokes the instance initialization method based on the object reference in the stack (and thus pop the reference from the stack to consume it). The exact class and method to execute is identified in this example by <em>#1</em> in the constant pool. Constant pool values associated to an identifier can be displayed with the <code>-v</code> option of <code>javap</code>. Finally, <em>return</em> terminates the execution of the constructor.</p>

<p>In summary, the JVM makes use of opcodes to execute basic instructions. The execution and pipelining of several instructions is made possible through an intermediary which is the stack. Values are pushed to and/or pop from when opcodes are executed.</p>

<p>Now, let&#39;s take a look at the instructions and their associated comments for the <em>main</em> method. At code <em>7</em>, a new instance of <em>StringBuilder</em> is created, then at code <em>11</em> the empty String is appended to the <em>StringBuilder</em> object by using the append method. Similarly, at code <em>16</em> the String &quot;some more data&quot; is concatenated before retrieving a String representation with the help of the <em>toString</em> method (code 19). Finally, once the reference to the static field PrintStream is fetched (code 8), the value is displayed on the standard output (code 27).</p>

<p>If you have followed what I said before, you may ask why is an instance of StringBuilder created? after all the code source has no reference to <em>StringBuilder</em>. The answer lies in the fact that all of the substrings building the final String are known at compile time. In this specific case, the Java compiler (written by people who know the drawback of the <em>+</em> operator) optimizes the bytecode that is generated. In our case, String concatenation with the <em>+</em> operator is replaced by:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">new</span> <span class="n">StringBuilder</span><span class="o">().</span><span class="na">append</span><span class="o">(</span><span class="s">""</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"some more data"</span><span class="o">);</span>
</code></pre></div>
<p>This optimization is known as a static string concatenation optimization and is available since Java 5.</p>

<p>So, does it means that all the previous explanations about the cost of the <em>+</em> operator no longer hold? at this point it&#39;s true for <em>static</em> string concatenation. However, investigations are still required with <em>dynamic</em> string concatenation.</p>

<h1 id="going-further-with-dynamic-string-concatenation">Going further with dynamic string concatenation</h1>

<p>Dynamic string concatenation refers to the concatenation of substrings whose the result is known at runtime only. This is for instance the case for substrings appended to a String in a for loop:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamicStringConcatenation</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s">"some more data"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Below is the disassembled human readable bytecode:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="err">$</span> <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">classes</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">DynamicStringConcatenation</span><span class="o">.</span><span class="na">class</span>
<span class="n">Compiled</span> <span class="n">from</span> <span class="s">"DynamicStringConcatenation.java"</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamicStringConcatenation</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">DynamicStringConcatenation</span><span class="o">();</span>
    <span class="nl">Code:</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">aload_0</span>          <span class="c1">// Push 'this' on to the stack</span>
       <span class="mi">1</span><span class="o">:</span> <span class="n">invokespecial</span> <span class="err">#</span><span class="mi">1</span> <span class="c1">// Invoke Object class constructor</span>
                           <span class="c1">// pop 'this' ref from the stack</span>
       <span class="mi">4</span><span class="o">:</span> <span class="k">return</span>           <span class="c1">// Return from constructor</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]);</span>
    <span class="nl">Code:</span>
       <span class="mi">0</span><span class="o">:</span> <span class="n">ldc</span>            <span class="err">#</span><span class="mi">2</span> <span class="c1">// Load constant #2 on to the stack</span>
       <span class="mi">2</span><span class="o">:</span> <span class="n">astore_1</span>          <span class="c1">// Create local var from stack, pop #2</span>
       <span class="mi">3</span><span class="o">:</span> <span class="n">iconst_0</span>          <span class="c1">// Push value 0 onto the stack</span>
       <span class="mi">4</span><span class="o">:</span> <span class="n">istore_2</span>          <span class="c1">// Pop value and store it in local var</span>
       <span class="mi">5</span><span class="o">:</span> <span class="n">iload_2</span>           <span class="c1">// Push local var 2 on to the stack</span>
       <span class="mi">6</span><span class="o">:</span> <span class="n">i2d</span>               <span class="c1">// Convert int to double on</span>
                            <span class="c1">// top of stack (pop + push)</span>
       <span class="mi">7</span><span class="o">:</span> <span class="n">ldc2_w</span>         <span class="err">#</span><span class="mi">3</span> <span class="c1">// Push constant 10e6 on to the stack</span>
      <span class="mi">10</span><span class="o">:</span> <span class="n">dcmpg</span>             <span class="c1">// Compare two doubles on top of stack</span>
                            <span class="c1">// pop twice, push result: -1, 0 or 1</span>
      <span class="mi">11</span><span class="o">:</span> <span class="n">ifge</span>           <span class="mi">40</span> <span class="c1">// if value on top of stack is greater</span>
                            <span class="c1">// than or equal to 0 (pop once)</span>
                            <span class="c1">// branch to instruction at code 40</span>
      <span class="mi">14</span><span class="o">:</span> <span class="k">new</span>            <span class="err">#</span><span class="mi">5</span> <span class="c1">// Push new StringBuilder ref on stack</span>
      <span class="mi">17</span><span class="o">:</span> <span class="n">dup</span>               <span class="c1">// Duplicate value on top of the stack</span>
      <span class="mi">18</span><span class="o">:</span> <span class="n">invokespecial</span>  <span class="err">#</span><span class="mi">6</span> <span class="c1">// Invoke StringBuilder constructor</span>
                            <span class="c1">// pop object reference</span>
      <span class="mi">21</span><span class="o">:</span> <span class="n">aload_1</span>           <span class="c1">// Push local var 1 (empty String)</span>
                            <span class="c1">// on to the stack</span>
      <span class="mi">22</span><span class="o">:</span> <span class="n">invokevirtual</span>  <span class="err">#</span><span class="mi">7</span> <span class="c1">// Invoke StringBuilder.append</span>
                            <span class="c1">// pop obj ref + param, push result</span>
      <span class="mi">25</span><span class="o">:</span> <span class="n">ldc</span>            <span class="err">#</span><span class="mi">8</span> <span class="c1">// Push "some more data" on the stack</span>
      <span class="mi">27</span><span class="o">:</span> <span class="n">invokevirtual</span>  <span class="err">#</span><span class="mi">7</span> <span class="c1">// Invoke StringBuilder.append</span>
                            <span class="c1">// pop obj ref + param, push result</span>
      <span class="mi">30</span><span class="o">:</span> <span class="n">invokevirtual</span>  <span class="err">#</span><span class="mi">9</span> <span class="c1">// Invoke StringBuilder.toString</span>
                            <span class="c1">// pop object reference</span>
      <span class="mi">33</span><span class="o">:</span> <span class="n">astore_1</span>          <span class="c1">// Create local var from stack (pop)</span>
      <span class="mi">34</span><span class="o">:</span> <span class="n">iinc</span>         <span class="mi">2</span><span class="o">,</span> <span class="mi">1</span> <span class="c1">// Increment local variable 2 by 1</span>
      <span class="mi">37</span><span class="o">:</span> <span class="k">goto</span>            <span class="mi">5</span> <span class="c1">// Move to instruction at code 5</span>
      <span class="mi">40</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="mi">10</span> <span class="c1">// Push value System.out:PrintStream</span>
      <span class="mi">43</span><span class="o">:</span> <span class="n">aload_1</span>           <span class="c1">// Push local var 1 (result String)</span>
      <span class="mi">44</span><span class="o">:</span> <span class="n">invokevirtual</span> <span class="err">#</span><span class="mi">11</span> <span class="c1">// Invoke method PrintStream.println()</span>
                            <span class="c1">// pop twice (object ref + parameter)</span>
      <span class="mi">47</span><span class="o">:</span> <span class="k">return</span>            <span class="c1">// Return void from method</span>
<span class="o">}</span>
</code></pre></div>
<p>If you look quickly at the instructions and comments, you can see there are some references to <em>StringBuilder</em>. However, it does not mean that, in this context, String concatenation is &quot;optimized&quot;. A closer look (by drawing for instance how the <em>stack</em> evolves) will show you that a new <em>StringBuilder</em> instance is created per iteration. That&#39;s because optimization for static string concatenation is applied in the body of the loop but not outside. The compiler cannot compute the concatenating result without executing the instructions, which is not its role.</p>

<p>Supposing that the source code associated to the bytecode of the class <em>DynamicStringConcatenation</em> has to be displayed, then this one would look as follows:  </p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">StringBuilder</span> <span class="n">tmp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
    <span class="n">tmp</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="n">tmp</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"some more data"</span><span class="o">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</code></pre></div>
<p>Based on the code, it means that explanations given in <a href="#understanding-the-issue">Understanding the issue</a> section about the performance issue still hold for dynamic String concatenation. Using the <em>+</em> operator for concatenating substrings to a String defined outside the body of the loop will cause severe performance degradations.
Although <em>StringBuilder</em> is used by the compiler, an instance must be created at each iteration and the characters inside the <em>result</em> variable copied to the <em>StringBuilder</em> instance before appending &quot;some more data&quot; and returning a String representation with <em>toString</em>. This last incurring another copy of characters contained by the <em>StringBuilder</em> instance.</p>

<p>One solution is to manually create a <em>StringBuilder</em> instance outside the loop:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span><span class="mi">1</span><span class="n">e6</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">e6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"some more data"</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</code></pre></div>
<p>Besides, if you know in advance the total number of characters that will be appended to the <em>StringBuilder</em> instance, you can pass this value to the constructor. It will prevent some resize operations and thus give better results.</p>

<h1 id="assessing-performance-with-micro-benchmarks">Assessing performance with micro-benchmarks</h1>

<p>Until now it has been clarified that dynamic string concatenation with the <em>+</em> operator is not optimized in Java 8 by the compiler, similarly to previous Java versions. However, nothing can be concluded yet. Indeed, the JVM is highly optimized and optimizations which are not made at compile time can be performed at runtime by the <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">Just-In-Time (JIT)</a> compiler.</p>

<p>The purpose of the JIT is twofold. First it is used to analyze method calls in background and to compile the bytecode of methods that are frequently used into native CPU instructions. Thus, once a method has been compiled, its native form is used, which avoids an indirection with the interpretation of the bytecode. Second, the JIT can analyze dynamic runtime information to make optimizations that a compiler cannot. For example, inlining functions that are used frequently, eliminating dead code, removing locks if monitor is not reachable from other threads, etc. This way, a code written in Java may sometimes run faster than its equivalent in C.</p>

<p>Since the Java HotSpot Performance Engine (JVM) apply many optos, maybe some magic tricks with dynamic string concatenation occurs at runtime. To check this assumption, the best is to <a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/dae2d83e0ec2/src/share/vm/opto/stringopts.cpp">look at the implementation</a> but it would require too much time without the guarantee not to forget to look at a piece of code. Another solution is to write micro-benchmarks to compare the time required to concatenate Strings in a for loop using the <em>+</em> operator vs an instance of <em>StringBuilder</em> .</p>

<p>Writing micro-benchmarks, especially in Java is not easy. As explained before, the JIT is performing many optimizations in a transparent manner. It implies to be aware of its optimizations, the effects of initialization, recompilation, etc. to write a meaningful micro-benchmark. Otherwise, you might measure something completely wrong. Hopefully, some libraries exist to help in this task. Especially, <a href="http://openjdk.java.net/projects/code-tools/jmh/">Java Microbenchmark Harness (JMH)</a> which has the advantage to be written by <del>Russians</del> people working on the JIT implementation.</p>

<p>Below are the micro-benchmarks written to assess String concatenation performance using JMH:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@State</span><span class="o">(</span><span class="n">Scope</span><span class="o">.</span><span class="na">Thread</span><span class="o">)</span>
<span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="n">Mode</span><span class="o">.</span><span class="na">SingleShotTime</span><span class="o">)</span>
<span class="nd">@Measurement</span><span class="o">(</span><span class="n">batchSize</span> <span class="o">=</span> <span class="mi">100000</span><span class="o">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">20</span><span class="o">)</span>
<span class="nd">@Warmup</span><span class="o">(</span><span class="n">batchSize</span> <span class="o">=</span> <span class="mi">100000</span><span class="o">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">10</span><span class="o">)</span>
<span class="nd">@Fork</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringConcatenationBenchmark</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">string</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">stringConcat</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">StringBuilder</span> <span class="n">stringBuilder</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">StringBuffer</span> <span class="n">stringBuffer</span><span class="o">;</span>

    <span class="nd">@Setup</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">Iteration</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">stringConcat</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="n">stringBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stringConcatenation</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s">"some more data"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stringConcatConcatenation</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">stringConcat</span> <span class="o">=</span> <span class="n">stringConcat</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="s">"some more data"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stringBuilderConcatenation</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"some more data"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stringBufferConcatenation</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">stringBuffer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"some more data"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>The previous class is <a href="https://github.com/lpellegr/experiments/blob/master/java/string-concatenation/src/jmh/java/link/pellegrino/string_concatenation/StringConcatenationBenchmark.java">available on Github</a> packaged in a gradle project. If you want to run micro-benchmarks on your side, you can as follows once the project is cloned:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>./gradlew jmh
</code></pre></div>
<p>Briefly speaking, iterations are made by JMH using the <em>batchSize</em> parameter with <em>Measurement</em> and <em>Warmup</em> annotations. This last annotation is useful to perform runs that aim to warm the JVM so that JIT optimizations are in place when measurements are made. More information about JMH and its annotations can be found on <a href="http://java-performance.info/jmh/">java-performance.info</a>.</p>

<p>The next figure sketches the trends:</p>

<p><a href="https://docs.google.com/spreadsheets/d/1dV4Pbe2_ZCsc9TDBYsN9u69a2a3xSjCAzxKR7I6fxzg/edit?usp=sharing" target="_blank"><img src="https://docs.google.com/spreadsheets/d/1dV4Pbe2_ZCsc9TDBYsN9u69a2a3xSjCAzxKR7I6fxzg/pubchart?oid=1847999196&format=image" alt="tre"></a></p>

<p>Using <em>StringBuilder</em>/<em>StringBuffer</em> clearly outperform other approaches which use the <em>+</em> operator or <em>String#concat(String)</em> for dynamic String concatenation. Although <em>String#concat(String)</em> scales in a similar manner as the method based on the <em>+</em> operator, the difference of performance between both may be explained by the fact that no transformation is performed by the compiler for <em>String#concat(String)</em>. This last does not require to create multiple StringBuilder instances while avoiding the extra copy incurred by the call to <em>StringBuilder#toString()</em>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>In summary, Java 8 seems not to introduce new optimizations for String concatenation with the <em>+</em> operator. It means that using <em>StringBuilder</em> manually is still required for specific cases where the compiler or the JIT is not applying magic tricks. For instance, when lot of substrings are concatenated to a String variable defined outside the scope of a loop.</p>

<p>The reason for not optimizing automatically all String concatenations is still a bit obscure to me. Probably, too much information and efforts are required to handle  all possible cases safely. After all, that&#39;s also a good point to make programmers think about what they write.</p>

<p>If you are interested by String optimizations in Java and their associated methods, I recommend to have a look at the interesting <a href="http://shipilev.net/talks/joker-Oct2014-string-catechism.pdf">slides made by Aleksey Shipilёv</a>.</p>

  </div>

  <div itemprop="keywords">
    Tags:
    
      <a href="http://www.google.com/search?q=Java&btnI=I%27m%20feeling%20lucky">Java</a>, 
    
      <a href="http://www.google.com/search?q=String Concatenation&btnI=I%27m%20feeling%20lucky">String Concatenation</a>, 
    
      <a href="http://www.google.com/search?q=Dynamic String Concatenation&btnI=I%27m%20feeling%20lucky">Dynamic String Concatenation</a>, 
    
      <a href="http://www.google.com/search?q=Static String Concatenation&btnI=I%27m%20feeling%20lucky">Static String Concatenation</a>, 
    
      <a href="http://www.google.com/search?q=StringBuilder&btnI=I%27m%20feeling%20lucky">StringBuilder</a>, 
    
      <a href="http://www.google.com/search?q=StringBuffer&btnI=I%27m%20feeling%20lucky">StringBuffer</a>, 
    
      <a href="http://www.google.com/search?q=Javap&btnI=I%27m%20feeling%20lucky">Javap</a>, 
    
      <a href="http://www.google.com/search?q=JIT&btnI=I%27m%20feeling%20lucky">JIT</a>, 
    
      <a href="http://www.google.com/search?q=Just-In-Time compiler&btnI=I%27m%20feeling%20lucky">Just-In-Time compiler</a>, 
    
      <a href="http://www.google.com/search?q=JMH&btnI=I%27m%20feeling%20lucky">JMH</a>
    
  </div>
</article>





<div id="disqus_thread"></div>
<script type="text/javascript">
        var disqus_shortname = 'lpellegr';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



				</div>
			</section>
		</div>
	</div>
	<script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-59741838-1', 'auto');
	ga('send', 'pageview');
  </script>
</body>
</html>
