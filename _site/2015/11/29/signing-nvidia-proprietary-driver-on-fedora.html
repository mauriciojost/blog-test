<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Laurent Pellegrino">
  <meta name="theme-color" content="#284a5e">
  <title>Signing Nvidia proprietary driver on Fedora</title>
  <meta name="description" content="Two weeks ago I have upgraded my machine to Fedora 23. I fought a bit with theinstallation of Nvidia proprietary driver. The main reason was that new kernelm...">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.pellegrino.link/2015/11/29/signing-nvidia-proprietary-driver-on-fedora.html">
  <link rel="alternate" type="application/rss+xml" title="Laurent Pellegrino" href="http://www.pellegrino.link/feed.xml">
</head>

<body>
	<div id="container">
		<div id="row">
			<header id="sidebar">
  <a href="/"/>
    <img src="/images/giraffe.png" class="avatar" alt="Cartoon giraffe" />
  </a>

  <h1>
    <strong>I am Laurent</strong>,<br /> a Software Engineer</h1>

  <nav class="site-nav vspace">
    <a href="/" class="navlink">Blog</a>
    <span style="font-size: 10px;">&nbsp;&bull;&nbsp;</span>
    <a href="/archives" class="navlink">Archives</a>
    <span style="font-size: 10px;">&nbsp;&bull;&nbsp;</span>
    <a href="/about" class="navlink">About</a>
  </nav>

  <ul class="icons vspace">
    <li><a href="http://linkedin.pellegrino.link" class="icon fa-linkedin" title="Linkedin profile"><span class="label">Linkedin</span></a></li>
    <li><a href="https://github.com/lpellegr" class="icon fa-github" title="Github profile"><span class="label">Github</span></a></li>
    <li><a href="http://stackoverflow.com/users/269447/laurent" class="icon fa-stack-overflow" title="Stackoverflow profile"><span class="label">Stack Overflow</span></a></li>
    <li><a href="http://www.google.com/recaptcha/mailhide/d?k=01aQ9xMzKtmiI_QFsoA7_5cw==&amp;c=tRqec_6YI_OyihG21CXPRw7EZ3YIpLSQjW_ZCODLh0s=" onclick="window.open('http://www.google.com/recaptcha/mailhide/d?k\07501aQ9xMzKtmiI_QFsoA7_5cw\75\75\46c\75tRqec_6YI_OyihG21CXPRw7EZ3YIpLSQjW_ZCODLh0s\075', '', 'toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=500,height=300'); return false;" title="Reveal this e-mail address" class="icon fa-envelope-o"><span class="label">Email</span></a></li>
  </ul>
</header>

			<section id="page-content">
				<div id="content">
					<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <p class="post-meta"><time datetime="2015-11-29T00:00:00+01:00" itemprop="datePublished">Nov 29, 2015</time></p>
    <h1 class="post-title" itemprop="name headline">Signing Nvidia proprietary driver on Fedora</h1>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Two weeks ago I have upgraded my machine to Fedora 23. I fought a bit with the
installation of Nvidia proprietary driver. The main reason was that new kernel
modules to load need to be signed with a key accepted by <a href="https://docs.fedoraproject.org/en-US/Fedora/23/html/System_Administrators_Guide/sect-signing-kernel-modules-for-secure-boot.html">Secure Boot</a>.
Below are steps I have followed to achieve this configuration.</p>

<!--more-->

<h1 id="creating-new-x-509-key-pair">Creating New X.509 Key Pair</h1>

<p>The <a href="https://www.openssl.org">openssl</a> tool can be used to generate a public
and private X.509 key pair that will be used to sign a kernel module after it
has been built.</p>

<p>First, it is recommended to create a configuration file to pass parameters.
Hereafter is an example named <em>x509-configuration.ini</em>. Values starting by
<code>YOUR_</code> need to be replaced by your own data:</p>
<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="nn">[ req ]</span>
<span class="py">default_bits</span> <span class="p">=</span> <span class="s">4096</span>
<span class="py">distinguished_name</span> <span class="p">=</span> <span class="s">req_distinguished_name</span>
<span class="py">prompt</span> <span class="p">=</span> <span class="s">no</span>
<span class="py">string_mask</span> <span class="p">=</span> <span class="s">utf8only</span>
<span class="py">x509_extensions</span> <span class="p">=</span> <span class="s">myexts</span>

<span class="nn">[ req_distinguished_name ]</span>
<span class="py">O</span> <span class="p">=</span> <span class="s">YOUR_USERNAME</span>
<span class="py">CN</span> <span class="p">=</span> <span class="s">YOUR_USERNAME</span>
<span class="py">emailAddress</span> <span class="p">=</span> <span class="s">YOUR_EMAIL_ADDRESS</span>

<span class="nn">[ myexts ]</span>
<span class="py">basicConstraints</span><span class="p">=</span><span class="s">critical,CA:FALSE</span>
<span class="py">keyUsage</span><span class="p">=</span><span class="s">digitalSignature</span>
<span class="py">subjectKeyIdentifier</span><span class="p">=</span><span class="s">hash</span>
<span class="py">authorityKeyIdentifier</span><span class="p">=</span><span class="s">keyid</span>
</code></pre></div>
<p>Then, key pair can be generated as follows:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 -batch -config x509-configuration.ini -outform DER -out public_key.der -keyout private_key.priv
</code></pre></div>
<p>Output are two files: <code>public_key.der</code> and <code>private_key.priv</code>.</p>

<h1 id="enrolling-public-key">Enrolling Public Key</h1>

<p>At boot, the kernel loads Secure Boot db key database into system keyring. Since
this last is used to check which kernel modules can be loaded, the public key
<code>public_key.der</code> needs to be enrolled in this database in order to accept new
modules signed with our private key <code>private_key.priv</code>.</p>

<p>Usually, this operation can be achieved with <em>mokutil</em> Fedora userspace utility:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">mokutil --import mpublic_key.der
</code></pre></div>
<p>Unfortunately, this utility was not working for me. I was always getting
<em>Failed to enroll new keys</em>. Hopefully, it is possible to enroll a new key
from the UEFI interface, directly.</p>

<p>First, copy file <code>public_key.der</code> on an USB key, then restart your machine and
press the appropriate key to access your UEFI interface.</p>

<p>In my case the right key is <em>F2</em>. Once pressed, the UEFI interface of my
<em>SABERTOOTH Z97 MARK 1</em> motherboard is displayed. To configure Secure Boot keys,
I clicked on <em>Advanced Mode</em>, <em>Boot</em>, <em>Secure Boot</em> and <em>Key Management</em>.
From the panel I selected <em>Append default DB keys</em>, answered <em>No</em> to the question
that asked if I wanted to append default DB keys. This way it asked me from
where I wanted to load keys. It allowed me to select my public key from USB key.</p>

<p>Once loaded, you can restart your machine. All new kernel modules signed with
the private key generated previously should be loaded with success by the
kernel.</p>

<h1 id="signing-kernel-module">Signing kernel module</h1>

<p>Move to the folder that contains the nvidia kernel module compiled. If
proprietary driver was installed by <code>dnf</code> the location should be
<code>/usr/lib/modules/$(uname -r)/extra/nvidia-340xx/</code>.</p>

<p>At this location, two files should be available: <code>nvidia.ko</code> and
<code>nvidia-uvm.ko</code>.</p>

<p>Signing both modules is as simple as follows (assuming package <code>kernel-devel</code>
is installed):</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">perl /usr/src/kernels/<span class="k">$(</span>uname -r<span class="k">)</span>/scripts/sign-file sha256 ~/private_key.priv  ~/public_key.der  nvidia.ko
perl /usr/src/kernels/<span class="k">$(</span>uname -r<span class="k">)</span>/scripts/sign-file sha256 ~/private_key.priv  ~/public_key.der  nvidia-uvm.ko
</code></pre></div>
<p>Then, module can be loaded with <code>insmod</code> and loaded modules listed with
<code>listmod</code>.</p>

  </div>

  <div itemprop="keywords">
    Tags:
    
      <a href="http://www.google.com/search?q=Secure Boot&btnI=I%27m%20feeling%20lucky">Secure Boot</a>, 
    
      <a href="http://www.google.com/search?q=Nvidia proprietary driver&btnI=I%27m%20feeling%20lucky">Nvidia proprietary driver</a>, 
    
      <a href="http://www.google.com/search?q=Fedora 23&btnI=I%27m%20feeling%20lucky">Fedora 23</a>, 
    
      <a href="http://www.google.com/search?q=Signing kernel module&btnI=I%27m%20feeling%20lucky">Signing kernel module</a>
    
  </div>
</article>





<div id="disqus_thread"></div>
<script type="text/javascript">
        var disqus_shortname = 'lpellegr';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



				</div>
			</section>
		</div>
	</div>
	<script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-59741838-1', 'auto');
	ga('send', 'pageview');
  </script>
</body>
</html>
