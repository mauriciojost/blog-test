<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Mauricio Jost">
  <meta name="theme-color" content="#284a5e">
  <title>Exception Handling in Spark 2.x</title>
  <meta name="description" content="Why Exception Handling (E.H.) in Spark?">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://mauriciojost.github.io/2017/11/07/exception-handling-in-spark-2/post.html">
  <link rel="alternate" type="application/rss+xml" title="Mauricio Jost" href="http://mauriciojost.github.io/feed.xml">
</head>

<body>
	<div id="container">
		<div id="row">
			<header id="sidebar">
  <a href="/"/>
    <img src="/images/mjost-profile-photo.jpg" class="avatar" alt="Mauricio Jost" />
  </a>

  <h1>
    <strong>I am Mauricio</strong><br />and these are my two cents</h1> 

  <nav class="site-nav vspace">
    <a href="/" class="navlink">Blog</a>
    <span style="font-size: 10px;">&nbsp;&bull;&nbsp;</span>
    <a href="/archives" class="navlink">Archives</a>
    <span style="font-size: 10px;">&nbsp;&bull;&nbsp;</span>
    <a href="/about" class="navlink">About</a>
  </nav>

  <ul class="icons vspace">
    <li><a href="https://www.linkedin.com/in/mauriciojost/" class="icon fa-linkedin" title="Linkedin profile"><span class="label">Linkedin</span></a></li>
    <li><a href="https://github.com/mauriciojost" class="icon fa-github" title="Github profile"><span class="label">Github</span></a></li>
    <li><a href="http://stackoverflow.com/users/1554927/mauriciojost" class="icon fa-stack-overflow" title="Stackoverflow profile"><span class="label">Stack Overflow</span></a></li>
  </ul>
</header>

			<section id="page-content">
				<div id="content">
					<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <p class="post-meta"><time datetime="2017-11-07T23:00:00+01:00" itemprop="datePublished">Nov 7, 2017</time></p>
    <h1 class="post-title" itemprop="name headline">Exception Handling in Spark 2.x</h1>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1 id="why-exception-handling-e-h-in-spark">Why Exception Handling (E.H.) in Spark?</h1>

<ul>
<li><strong>data is rarely ideal</strong></li>
<li>some scenarios don&#39;t deserve an <strong>immediate</strong> halt</li>
<li>investigate newer scenarios as-per-priority (happier customers)</li>
<li>ease product evolution</li>
<li>understand application limitations</li>
</ul>

<!--slide-next-->

<!--more-->

<h1 id="what-are-exceptions">What are Exceptions?</h1>

<p>Exceptions are <strong>failures</strong> that <strong>prevent our code from completing successfully an operation</strong>.</p>

<!--slide-ignore-begin-->

<p>Generally speaking, in the batch &amp; streaming processing world, correctly handling exceptions
gives the development team more time to evaluate logs and better decide how to handle different scenarios.</p>

<!--slide-ignore-end-->

<!--slide-next-->

<h1 id="types-of-failures">Types of Failures</h1>

<!--slide-ignore-begin-->

<p>Failures <a href="https://tersesystems.com/blog/2012/12/27/error-handling-in-scala/">can be classified as</a>:</p>

<ul>
<li><strong>Expected Internal</strong> (a circuit breaker)</li>
<li><strong>Expected External</strong> (a parsing exception)</li>
<li><strong>Unexpected Internal</strong> (a <code>NullPointerException</code>)</li>
<li><strong>Unexpected External</strong> (a host down)</li>
</ul>

<!--slide-ignore-end-->

<p>Among others, failures can be classified by importance:</p>

<ul>
<li><code>NonFatal</code> (can be recovered)</li>
<li><code>Fatal</code> (cannot be recovered)</li>
</ul>

<!--slide-down-->

<p>Or by determinism:</p>

<ul>
<li><code>Deterministic</code> (can be reproduced consistently)</li>
<li><code>Non deterministic</code></li>
</ul>

<!--slide-next-->

<h2 id="spark-exception-handling-e-h">Spark Exception Handling (E.H.)</h2>

<p>Generally speaking, Spark exceptions can be divided in two groups:</p>

<ul>
<li><strong>Unexpected failures</strong>: generally non-deterministic, fatal or non fatal (Spark framework via task retries)</li>
<li><strong>Expected failures</strong>: generally deterministic, non fatal -&gt; <strong>this post</strong></li>
</ul>

<!--slide-next-->

<h1 id="application-e-h-approaches">Application E.H. approaches</h1>

<ul>
<li>The no-exception-handling approach</li>
<li>The try-catch and log approach</li>
<li>The <code>Try</code> / <code>Either</code> approach</li>
<li>The Accumulator approach</li>
<li>More evolved approaches</li>
</ul>

<!--slide-next-->

<h2 id="the-no-exception-handling-approach">The no-exception-handling approach</h2>

<p><strong>The world has to be ideal, or crash.</strong></p>

<p>The Spark app will fail if upon retries a task keeps failing.</p>

<pre><code class="scala" data-trim contenteditable>
def country(cityCode: String): String = {
  cities(cityCode).get.country
  // the city has to be found!
}
</code></pre>

<!--slide-down-->

<p>When to use? Prototypes only.</p>

<!--slide-next-->

<h2 id="the-try-catch-and-log-approach">The try-catch and log approach</h2>

<p>Report unexpected scenarios via logs.</p>

<ul>
<li>May generate significant amount of logs (performance!)</li>
<li>Generally not purely functional</li>
</ul>

<pre><code class="scala" data-trim contenteditable>
def country(cityCode: String): String = {
  try {
    cities(cityCode).get.country
  } catch {
    Log.warn(s"Unexpected city $cityCode")
    "UnknownCountry"
  }
}
</code></pre>

<!--slide-down-->

<h3 id="when-to-use">When to use?</h3>

<p>Not really appealing:</p>

<ul>
<li>Requires the use of RM tools to retrieve logs (as not in HDFS)</li>
<li>Difficult to test</li>
<li>However provides by default multiple levels of seriousness</li>
</ul>

<!--slide-next-->

<h2 id="the-try-either-approach">The <code>Try</code> / <code>Either</code> approach</h2>

<p>Return <code>Try</code> / <code>Either</code> types always.</p>

<ul>
<li>Purely functional</li>
<li><code>Exception</code> reports are part of the output of a transformation</li>
</ul>

<pre><code class="scala" data-trim contenteditable>
def country(cityCode: String): Try[String] = {
  Try{cities(cityCode).get.country}
}
</code></pre>

<!--slide-down-->

<h3 id="when-to-use">When to use?</h3>

<p>Maybe the most appealing approach:</p>

<ul>
<li>Results are stored in HDFS</li>
<li>Easy to test</li>
<li>Easy to reason about</li>
<li>Spark/Hadoop agnostic</li>
<li>Can be tricky to save simultaneously <code>Success</code>/<code>Right</code> and <code>Failure</code>/<code>Left</code> sides (could be slow, requiring multiple actions to be triggered)</li>
<li>Does not provide support for levels of seriousness</li>
</ul>

<!--slide-next-->

<h2 id="the-accumulator-approach">The Accumulator approach</h2>

<p>Use the Spark <code>Accumulator</code> mechanism to report statistics on specific scenarios.</p>

<ul>
<li>Not meant to retrieve detailed information about the failure</li>
<li>Function argument is mutable (often seen as bad practice)</li>
</ul>

<pre><code class="scala" data-trim contenteditable>
def country(cityCode: String, ac: Accumulator): String = {
  cities(cityCode) match {
    case Some(city) => city.country
    case None => {ac += 1; "UnknownCountry"}
  }
}
</code></pre>

<!--slide-down-->

<h3 id="when-to-use">When to use?</h3>

<p>The Spark approach:</p>

<ul>
<li>Results can be printed in <code>stdout</code> or stored in HDFS easily</li>
<li>Relatively easy to test</li>
<li>Spark framework dependant</li>
<li>Should be very fast</li>
<li>Does not provide support for levels of seriousness</li>
</ul>

<!--slide-next-->

<h2 id="more-evolved-approaches">More evolved approaches</h2>

<p>Will be in a different post.</p>

<!--slide-next-->

<h1 id="enjoy">Enjoy!</h1>

<p>If you have any comments, let me know!</p>

  </div>

  <hr/>

  <div itemprop="keywords">
    Tags:
    
      <a href="http://www.google.com/search?q=scala&btnI=I%27m%20feeling%20lucky">scala</a>, 
    
      <a href="http://www.google.com/search?q=spark&btnI=I%27m%20feeling%20lucky">spark</a>, 
    
      <a href="http://www.google.com/search?q=error&btnI=I%27m%20feeling%20lucky">error</a>, 
    
      <a href="http://www.google.com/search?q=exception&btnI=I%27m%20feeling%20lucky">exception</a>, 
    
      <a href="http://www.google.com/search?q=handling&btnI=I%27m%20feeling%20lucky">handling</a>, 
    
      <a href="http://www.google.com/search?q=try&btnI=I%27m%20feeling%20lucky">try</a>, 
    
      <a href="http://www.google.com/search?q=catch&btnI=I%27m%20feeling%20lucky">catch</a>
    
  </div>
</article>





<div id="disqus_thread"></div>
<script type="text/javascript">
        var disqus_shortname = 'mauriciojost-github-io';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




				</div>
			</section>
		</div>
	</div>
	<script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
